<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teachable Machine Audio Model</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
<style>
  body, div {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    text-align: center; /* Center-align all text */
  }
  #title {
    font-size: 24px; /* Increase font size for title */
    color: #333;
    line-height: 1.5;
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
    margin-bottom: 20px; /* Equal bottom margin for spacing */
  }
  #label-container {
    font-size: 16px;
    color: #333;
    line-height: 1.5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .main-sound-source, .time-stamp, .decibel-level, .noise-status {
    font-size: 20px;
    font-weight: bold;
    margin-top: 20px; /* Equal top margin for spacing */
  }
  table {
    margin-top: 20px;
    margin-bottom: 20px; /* Equal top and bottom margins for spacing */
    border-collapse: collapse;
    width: 60%;
  }
  table, th, td {
    border: 1px solid #333;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #f2f2f2;
    font-weight: bold;
  }
</style>
</head>
<body>
<div id="title">Teachable Machine Audio Model</div>
<button type="button" onclick="init()">Start</button>
<div id="label-container"></div>

<script type="text/javascript">
const URL = "https://teachablemachine.withgoogle.com/models/relHEb2HD/";

async function createModel() {
  const checkpointURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";
  const recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
  await recognizer.ensureModelLoaded();
  return recognizer;
}

async function init() {
  const recognizer = await createModel();
  const classLabels = recognizer.wordLabels();
  const labelContainer = document.getElementById("label-container");

  // Create table for class labels and scores
  const table = document.createElement("table");
  const headerRow = document.createElement("tr");
  const headerLabel = document.createElement("th");
  headerLabel.innerHTML = "Class";
  const headerScore = document.createElement("th");
  headerScore.innerHTML = "Score (%)";
  headerRow.appendChild(headerLabel);
  headerRow.appendChild(headerScore);
  table.appendChild(headerRow);

  // Create rows for each class
  classLabels.forEach((label, i) => {
    const row = document.createElement("tr");
    const classCell = document.createElement("td");
    const scoreCell = document.createElement("td");
    classCell.innerHTML = label;
    scoreCell.innerHTML = "0%"; // Default value, to be updated
    row.appendChild(classCell);
    row.appendChild(scoreCell);
    table.appendChild(row);
  });
  labelContainer.appendChild(table);

  // Create containers for additional information
  const mainSoundDiv = document.createElement("div");
  mainSoundDiv.className = "main-sound-source";
  labelContainer.appendChild(mainSoundDiv);

  const timeStampDiv = document.createElement("div");
  timeStampDiv.className = "time-stamp";
  labelContainer.appendChild(timeStampDiv);

  const decibelLevelDiv = document.createElement("div");
  decibelLevelDiv.className = "decibel-level";
  labelContainer.appendChild(decibelLevelDiv);

  const noiseStatusDiv = document.createElement("div");
  noiseStatusDiv.className = "noise-status";
  labelContainer.appendChild(noiseStatusDiv);

  function updateResults() {
    const scores = recognizer.scores;
    let highestScore = -1;
    let highestLabel = "";
    classLabels.forEach((label, i) => {
      const score = (scores[i] * 100).toFixed(2);
      const row = table.rows[i + 1]; // Get the table row for this label
      row.cells[1].innerHTML = `${score}%`; // Update score in table

      if (score > highestScore) {
        highestScore = score;
        highestLabel = label;
      }
    });

    const mainSoundSource = `Main sound source: ${highestLabel}`;
    mainSoundDiv.innerHTML = mainSoundSource;

    // Get current time and classify as day, evening, or night
    const currentTime = new Date();
    const hours = currentTime.getHours();
    let timePeriod = "";
    let disruptionThreshold = 0;

    if (hours >= 7 && hours < 19) {
      timePeriod = "Day";
      disruptionThreshold = 65;
    } else if (hours >= 19 && hours < 23) {
      timePeriod = "Evening";
      disruptionThreshold = 60;
    } else {
      timePeriod = "Night";
      disruptionThreshold = 55;
    }

    // Display time with time period
    timeStampDiv.innerHTML = `Time: ${timePeriod} ${currentTime.toLocaleTimeString()}`;

    // Simulate decibel level (for demonstration, we will use a random value)
    const decibelLevel = Math.floor(Math.random() * 100); // Random dBA for simulation
    decibelLevelDiv.innerHTML = `Decibel level: ${decibelLevel} dBA`;

    // Determine if the environment is "Normal" or "Disruption"
    const noiseStatus = decibelLevel > disruptionThreshold ? "Disruption" : "Normal";
    noiseStatusDiv.innerHTML = noiseStatus;
  }

  // Listen to audio and update results
  recognizer.listen(result => {
    recognizer.scores = result.scores;
  }, {
    includeSpectrogram: true,
    probabilityThreshold: 0.75,
    invokeCallbackOnNoiseAndUnknown: true,
    overlapFactor: 0.50
  });

  // Update results every 5 seconds
  setInterval(updateResults, 5000);

  // Stop the recognition in 60 seconds.
  // setTimeout(() => recognizer.stopListening(), 60000);
}
</script>
</body>
</html>
